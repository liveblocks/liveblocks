name: Tests

on: [pull_request]

jobs:
  # Check if there are any code changes in the PR (not docs, examples, changelogs, etc.)
  # If not, the tests will be skipped and marked as successful
  check_for_code_changes:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read

    outputs:
      changes: ${{ steps.filter.outputs.changes }}

    steps:
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          predicate-quantifier: "every"
          filters: |
            changes:
              - '**/*'
              - '!docs/**'
              - '!examples/**'
              - '!guides/**'
              - '!starter-kits/**'
              - '!tutorials/**'
              - '!CHANGELOG.md'
              - '!CHANGELOG_PUBLIC.md'

  test:
    needs: check_for_code_changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.21.0]
        pkg:
          [
            "@liveblocks/core",
            "@liveblocks/client",
            "@liveblocks/react",
            "@liveblocks/redux",
            "@liveblocks/zustand",
            "@liveblocks/node",
            "@liveblocks/yjs",
            "@liveblocks/react-ui",
            "@liveblocks/react-lexical",
            "@liveblocks/react-tiptap",
            "@liveblocks/react-blocknote",
            "@liveblocks/node-lexical",
            "@liveblocks/node-prosemirror",
            "@liveblocks/codemod",
            "@liveblocks/emails",
          ]

    steps:
      - name: Checkout
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/checkout@v4

      - name: Use Node ${{ matrix.node-version }}
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm install

      - name: Turbo Cache
        if: needs.check_for_code_changes.outputs.changes == 'true'
        id: turbo-cache
        uses: actions/cache@v4
        with:
          key: turbo-cache-${{ matrix.node-version }}-${{ matrix.pkg }}-bust3
          path: node_modules/.cache/turbo
          restore-keys:
            turbo-cache-${{ matrix.node-version }}-${{ matrix.pkg }}-bust3

      - name: Install Bun
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: oven-sh/setup-bun@v1

      - name: Build
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run build -- --filter ${{ matrix.pkg }}

      - name: Ensure no files are changed
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: |
          CHANGED=$(git status --porcelain)
          if [ -n "$CHANGED" ]; then
            echo "Local, uncommitted changes found:"
            echo "$CHANGED"
            exit 1
          fi

      - name: Run unit tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test -- --filter ${{ matrix.pkg }} -- --coverage

      - name: Run type tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test:types -- --filter ${{ matrix.pkg }}

      - name: Run dependency tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test:deps -- --filter ${{ matrix.pkg }}

      - name: Run lint checks
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run lint -- --filter ${{ matrix.pkg }}

      - name: Run public NPM packaging lint checks
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run lint:package -- --filter ${{ matrix.pkg }}

  # E2E tests defined in e2e/next-sandbox package
  e2e-next-sandbox:
    needs: check_for_code_changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.21.0]

    timeout-minutes: 60

    env:
      LIVEBLOCKS_SECRET_KEY: ${{ secrets.E2E_TEST_LIVEBLOCKS_SECRET_KEY }}
      NEXT_PUBLIC_GITHUB_SHA: ${{ github.sha }}
      NEXT_PUBLIC_LIVEBLOCKS_BASE_URL: ${{ vars.E2E_TEST_LIVEBLOCKS_BASE_URL }}
      NEXT_PUBLIC_LIVEBLOCKS_PUBLIC_KEY:
        ${{ secrets.E2E_TEST_LIVEBLOCKS_PUBLIC_KEY }}

    steps:
      - name: Checkout
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/checkout@v4

      - name: Use Node ${{ matrix.node-version }}
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm install

      - name: Install Playwright
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npx playwright install chromium --no-shell --with-deps

      - name: Run Playwright tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test -- --filter @liveblocks/next-sandbox

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: e2e/next-sandbox/playwright-report
          retention-days: 14

  # E2E tests defined in e2e/next-ai-kitchen-sink package
  e2e-next-ai-sandbox:
    needs: check_for_code_changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.21.0]

    timeout-minutes: 60

    env:
      NEXT_PUBLIC_GITHUB_SHA: ${{ github.sha }}
      NEXT_PUBLIC_LIVEBLOCKS_BASE_URL: ${{ vars.E2E_TEST_LIVEBLOCKS_BASE_URL }}
      NEXT_PUBLIC_LIVEBLOCKS_DEFAULT_COPILOT_ID:
        ${{ vars.NEXT_PUBLIC_LIVEBLOCKS_DEFAULT_COPILOT_ID }}
      LIVEBLOCKS_SECRET_KEY: ${{ secrets.E2E_TEST_LIVEBLOCKS_SECRET_KEY }}

    steps:
      - name: Checkout
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/checkout@v4

      - name: Use Node ${{ matrix.node-version }}
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm install

      - name: Install Playwright
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npx playwright install chromium --no-shell --with-deps

      - name: Run AI Playwright tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test -- --filter @liveblocks/next-ai-kitchen-sink

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ai-playwright-report
          path: e2e/next-ai-kitchen-sink/playwright-report
          retention-days: 14

  # E2E tests defined in e2e/node-sandbox package
  e2e-node-sandbox:
    needs: check_for_code_changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.21.0]

    timeout-minutes: 60

    env:
      LIVEBLOCKS_SECRET_KEY: ${{ secrets.E2E_TEST_LIVEBLOCKS_SECRET_KEY }}
      PUBLIC_LIVEBLOCKS_PUBLIC_KEY:
        ${{ secrets.E2E_TEST_LIVEBLOCKS_PUBLIC_KEY }}
      NEXT_PUBLIC_LIVEBLOCKS_PUBLIC_KEY:
        ${{ secrets.E2E_TEST_LIVEBLOCKS_PUBLIC_KEY }}
      NEXT_PUBLIC_LIVEBLOCKS_BASE_URL: ${{ vars.E2E_TEST_LIVEBLOCKS_BASE_URL }}

    steps:
      - name: Checkout
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/checkout@v4

      - name: Use Node ${{ matrix.node-version }}
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm install

      - name: Run node-sandbox tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test -- --filter node-sandbox

  # E2E tests defined in @liveblocks/core package
  e2e-client-specs:
    needs: check_for_code_changes
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.21.0]

    timeout-minutes: 60

    env:
      LIVEBLOCKS_PUBLIC_KEY: ${{ secrets.E2E_TEST_LIVEBLOCKS_PUBLIC_KEY }}

    steps:
      - name: Checkout
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/checkout@v4

      - name: Use Node ${{ matrix.node-version }}
        if: needs.check_for_code_changes.outputs.changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm install

      - name: Run e2e client specs tests
        if: needs.check_for_code_changes.outputs.changes == 'true'
        run: npm run test:e2e
        working-directory: packages/liveblocks-core
