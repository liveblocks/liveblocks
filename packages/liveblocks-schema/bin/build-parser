#!/bin/sh
set -eu

PROJROOT="$(git rev-parse --show-toplevel)"
INPUT=src/parser/schema-lang.pegjs
OUTPUT=src/parser/generated-parser.ts

FORCE=0
if [ $# -gt 0 ]; then
    if [ "$1" = "-f" ]; then
        FORCE=1
    fi
fi

main () {
    if [ ! -f "$OUTPUT" -o "$INPUT" -nt "$OUTPUT" -o $FORCE -eq 1 ]; then
        echo "Rebuilding parser..." >&2

        set +e
        node_modules/.bin/peggy                             \
            --plugin ./node_modules/ts-pegjs/src/tspegjs.js \
            --extra-options-file pegconfig.json             \
            --allowed-start-rules Document,TypeExpr         \
            --cache                                         \
            -o "$OUTPUT"                                    \
            "$INPUT"                                        \
            2>errors.log
        exitcode="$?"
        if [ "$exitcode" -gt 0 -o "$(cat errors.log | wc -l)" -gt 0 ]; then
            cat errors.log >&2
            rm -f "$OUTPUT" errors.log
            exit "$exitcode"
        fi
        rm -f errors.log
        set -e

        echo "Done" >&2
    else
        echo "Parser up to date" >&2
    fi
}

( cd "$PROJROOT" && main )
